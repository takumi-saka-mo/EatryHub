<!DOCTYPE html>
<html lang="ja">
<head>
  <link rel="apple-touch-startup-image" href="/static/mobile/splash-1290x2796.png"
  media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
  <meta charset="utf-8" />
  <title>EatryHub - Mobile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <link rel="apple-touch-icon" href="/static/mobile/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="EatryHub">
  <meta name="theme-color" content="#ffffff">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/mobile/apple-icon-180.png">
  <link rel="apple-touch-startup-image" href="/static/mobile/splash-1125x2436.png"
    media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)">
  <link rel="apple-touch-startup-image" href="/static/mobile/splash-750x1334.png"
    media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)">
  <link rel="apple-touch-startup-image" href="/static/mobile/splash-1290x2796.png"
    media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3)">
  <link rel="manifest" href="/static/mobile/manifest.json" />
  <link rel="apple-touch-icon" sizes="180x180" href="/static/mobile/apple-icon-180.png">
  <link rel="shortcut icon" type="image/png" href="/static/favicon.ico" />
  <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core@7.6.0/dist/ionic/ionic.esm.js"></script>
  <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core@7.6.0/dist/ionic/ionic.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core@7.6.0/css/ionic.bundle.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <style>
    :root {
      /* These examples use the same color: sienna. */    
      /* These examples use the same color: lightsteelblue. */
      --ion-background-color: #e6e6e6;
      --ion-background-color-contrast: #fff;}
    
    ion-tab-bar {
      padding-bottom: env(safe-area-inset-bottom);
    }
    

    ion-content {
      padding-bottom: calc(65px + env(safe-area-inset-bottom));
    }
    .card-entry {
      margin: 10px;
      padding: 10px;
      border-radius: 10px;
      background: white;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }

    .warning { border: 2px solid orange; }
    .overdue { background-color: #ffdddd; }
    .plan-レモン { border-left: 8px solid #f0e68c; }
    .plan-単品 { border-left: 8px solid #696969; }
    .plan-スーパー { border-left: 8px solid #87cefa; }
    .plan-食べ飲み90m { border-left: 8px solid #90ee90; }
    .plan-食べ飲み120m { border-left: 8px solid #32cd32; }
    table {
      width: 100%;
      font-size: 0.9rem;
      border-collapse: collapse;
    }
    th, td {
      padding: 4px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background: #eee;
      position: sticky;
      top: 0;
    }
    .alert-late {
      background-color: red !important;
      color: white !important;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    
    ion-tab-bar {
      padding-bottom: env(safe-area-inset-bottom);
    }
    
    ion-content {
      padding-bottom: calc(65px + env(safe-area-inset-bottom));
    }
    
    .table-container {
      padding-bottom: env(safe-area-inset-bottom);
    }
  </style>
</head>
<body>
  <ion-app>
    <ion-tabs>
      <ion-tab-bar slot="bottom">
        <ion-tab-button tab="home">
          <ion-icon name="home-outline"></ion-icon>
          <ion-label>ホーム</ion-label>
        </ion-tab-button>
        <ion-tab-button tab="cards">
          <ion-icon name="albums-outline"></ion-icon>
          <ion-label>カード</ion-label>
        </ion-tab-button>
        <ion-tab-button tab="table">
          <ion-icon name="grid-outline"></ion-icon>
          <ion-label>テーブル</ion-label>
        </ion-tab-button>
        <ion-tab-button tab="settings">
          <ion-icon name="settings-outline"></ion-icon>
          <ion-label>設定</ion-label>
        </ion-tab-button>
      </ion-tab-bar>

      <ion-tab tab="home">
        <ion-content>
          <ion-header translucent>
            <ion-toolbar>
              <ion-title>ホーム</ion-title>
            </ion-toolbar>
          </ion-header>
            <p>ホームタブ - 作成中</p>
            <ion-checkbox label-placement="start">Label at the Start</ion-checkbox>
        </ion-content>
      </ion-tab>

      <ion-tab tab="cards">
        <ion-content>
          <ion-header translucent>
            <ion-toolbar>
              <ion-title>カード表示</ion-title>
            </ion-toolbar>
          </ion-header>

          <ion-refresher id="card-refresher" slot="fixed">
            <ion-refresher-content
              pulling-icon="chevron-down-circle-outline"
              pulling-text="Pull to refresh"
              refreshing-spinner="circles"
              refreshing-text="更新中...">
            </ion-refresher-content>
          </ion-refresher>
      
          <div class="ion-padding">
            <input type="date" id="cardSelectedDate" class="form-control mb-2" />
          </div>
      
          <div id="card-container" class="ion-padding"></div>
        </ion-content>
      </ion-tab>

      <ion-tab tab="table">
        <ion-content>
          <ion-header translucent>
            <ion-toolbar>
              <ion-title>テーブル表示</ion-title>
            </ion-toolbar>
          </ion-header>
          
          <!-- リロード機能 -->
          <ion-refresher id="refresher" slot="fixed">
            <ion-refresher-content
              pulling-icon="chevron-down-circle-outline"
              pulling-text="Pull to refresh"
              refreshing-spinner="circles"
              refreshing-text="更新中...">
            </ion-refresher-content>
          </ion-refresher>
      
          <ion-content class="ion-padding">
            <input type="date" id="selectedDate" class="form-control" />
            <div class="table-container mb-5">
              <table>
                <thead>
                  <tr>
                    <th>卓番</th>
                    <th>プラン</th>
                    <th>人数</th>
                    <th>開始</th>
                    <th>ラスト</th>
                    <th>アウト</th>
                  </tr>
                </thead>
                <tbody id="table-body"></tbody>
              </table>
            </div>
          </ion-content>
        </ion-content>
      </ion-tab>
      <ion-tab tab="settings">
        <ion-content>
          <ion-header translucent>
            <ion-toolbar>
              <ion-title>設定</ion-title>
            </ion-toolbar>
          </ion-header>
          <ion-content class="ion-padding">
            <ion-item-group>
              <ion-item detail="true" routerLink="/main/settings/account">
                <ion-icon name="person-circle-outline" slot="start" size="small" class="menu-icon color-primary"></ion-icon>
                <ion-label i18n>アカウント</ion-label>
              </ion-item>
              <ion-item detail="true" routerLink="/main/settings/printer">
                <ion-icon name="print-outline" slot="start" size="small" class="menu-icon color-tertiary"></ion-icon>
                <ion-label i18n>プリンタ</ion-label>
              </ion-item>
              <ion-item>
                <ion-icon slot="start" size="small" class="menu-icon color-warning" name="moon"></ion-icon>
                <ion-toggle [(ngModel)]="isDark" (ionChange)="vm.changeTheme(isDark())"
                ><ng-container i18n>ダークモードを利用</ng-container></ion-toggle
                >
              </ion-item>
            </ion-item-group>
          </ion-content>
        </ion-content>
      </ion-tab>
    </ion-tabs>
  </ion-app>

  <script>
    function formatHHMM(value) {
      const raw = String(value || "").trim();
      if (/^\d{4}$/.test(raw)) {
        return `${raw.slice(0, 2)}:${raw.slice(2)}`;
      }
      return raw || "-";
    }
  
    function getTimeFromHHMM(str) {
      const raw = String(str || "").replace(/[^\d:]/g, "");
      const parts = raw.split(":");
      if (parts.length !== 2) return null;
      const d = new Date();
      d.setHours(parseInt(parts[0], 10), parseInt(parts[1], 10), 0, 0);
      return d;
    }
  
    function isPast(timeStr) {
      const t = getTimeFromHHMM(formatHHMM(timeStr));
      return t ? t < new Date() : false;
    }
  
    async function fetchData() {
      const date = document.getElementById("selectedDate").value || new Date().toISOString().slice(0, 10);
      const res = await fetch(`/TimeManagement/table-data-api/?selected_date=${date}`);
      const data = await res.json();
      const tbody = document.getElementById("table-body");
      tbody.innerHTML = "";
  
      data.forEach(record => {
        if (!record.plan_name && !record.table_number && !record.people_count && !record.start_time) return;
  
        let last = "", leave = "";
        if (["レモン"].includes(record.plan_name)) {
          last = formatHHMM(record.end_time);
          leave = formatHHMM(record.out_time);
        } else if (["食べ飲み90m", "食べ飲み120m", "スーパー"].includes(record.plan_name)) {
          // 先に文字をクリーンアップしてから formatHHMM に渡す
          last = formatHHMM(record.stay?.replace(/【[^】]*】/g, ""));
          leave = formatHHMM(record.extensions?.replace(/【[^】]*】/g, ""));
        }

        
        const tr = document.createElement("tr");

        // 背景色指定：会計済み → 灰色、請求済み → ピンク
        if (record.paymentChecked) {
          tr.style.backgroundColor = "#a9a9a9";
          tr.style.color = "black";
        } else if (record.invoiceChecked) {
          tr.style.backgroundColor = "#ffc0cb";
          tr.style.color = "black";
        }
        tr.innerHTML = `
          <td>${record.table_number || ""}</td>
          <td>${record.plan_name || ""}</td>
          <td>${record.people_count || ""}</td>
          <td>${formatHHMM(record.start_time)}</td>
          <td>${last}</td>
          <td>${leave}</td>
        `;
  
        const lastTd = tr.children[4];
        const leaveTd = tr.children[5];
  
        if (isPast(last) && !record.invoiceChecked) {
          lastTd.classList.add("alert-late");
        }
        if (isPast(leave) && !record.paymentChecked) {
          leaveTd.classList.add("alert-late");
        }
  
        tbody.appendChild(tr);
      });
  
      if (tbody.innerHTML.trim() === "") {
        tbody.innerHTML = `<tr><td colspan="7">データがありません</td></tr>`;
      }
    }
    async function fetchCardData() {
      const date = document.getElementById("cardSelectedDate").value || new Date().toISOString().slice(0, 10);
      const res = await fetch(`/TimeManagement/table-data-api/?selected_date=${date}`);
      const data = await res.json();
      const container = document.getElementById("card-container");
      container.innerHTML = "";
  
      data.forEach(record => {
        if (!record.plan_name && !record.table_number && !record.people_count && !record.start_time) return;
  
        let last = "", leave = "";
        if (["レモン"].includes(record.plan_name)) {
          last = formatHHMM(record.end_time);
          leave = formatHHMM(record.out_time);
        } else if (["食べ飲み90m", "食べ飲み120m", "スーパー"].includes(record.plan_name)) {
          last = formatHHMM(record.stay?.replace(/【[^】]*】/g, ""));
          leave = formatHHMM(record.extensions?.replace(/【[^】]*】/g, ""));
        }
  
        const card = document.createElement("div");
        card.className = `card-entry plan-${record.plan_name || ""}`;
  
        // 背景色：会計済み → 灰色、請求済み → ピンク
        if (record.paymentChecked) {
          card.style.backgroundColor = "#a9a9a9";
          card.style.color = "black";
        } else if (record.invoiceChecked) {
          card.style.backgroundColor = "#ffc0cb";
          card.style.color = "black";
        }
  
        card.innerHTML = `
          <h5><b>${record.table_number || "-"}</b></h5>
          <p><b>${record.plan_name || "-"}</b></p>
          <p><strong>人数:</strong> ${record.people_count || "-"}</p>
          <p><strong>開始:</strong> ${formatHHMM(record.start_time)}</p>
          <p><strong>ラスト:</strong> ${last}</p>
          <p><strong>アウト:</strong> ${leave}</p>
        `;
  
        container.appendChild(card);
      });
  
      if (container.innerHTML.trim() === "") {
        container.innerHTML = `<p>データがありません</p>`;
      }
    }
    
    document.addEventListener("DOMContentLoaded", () => {
      const cardDateInput = document.getElementById("cardSelectedDate");
      cardDateInput.value = new Date().toISOString().slice(0, 10);
      fetchCardData();
      cardDateInput.addEventListener("change", fetchCardData);
    });
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("selectedDate").value = new Date().toISOString().slice(0, 10);
      fetchData();
      setInterval(fetchData, 60000);
      document.getElementById("selectedDate").addEventListener("change", fetchData);
    });
    document.addEventListener("DOMContentLoaded", () => {
      const dateInput = document.getElementById("selectedDate");
      const refresher = document.getElementById("refresher");
  
      dateInput.value = new Date().toISOString().slice(0, 10);
      fetchData();
      setInterval(fetchData, 60000);
  
      dateInput.addEventListener("change", fetchData);
  
      // Refresh
      refresher.addEventListener('ionRefresh', (event) => {
        fetchData().finally(() => {
          refresher.complete();
        });
      });
    });
    document.addEventListener("DOMContentLoaded", () => {
      const cardRefresher = document.getElementById("card-refresher");
      if (cardRefresher) {
        cardRefresher.addEventListener("ionRefresh", () => {
          fetchCardData().finally(() => {
            cardRefresher.complete();
          });
        });
      }
    });
  </script>
</body>
</html>
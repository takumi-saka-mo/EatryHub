<!DOCTYPE html>
<html lang="ja">
<head>
  <link rel="apple-touch-startup-image" href="/static/mobile/splash-1290x2796.png"
  media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
  <meta charset="utf-8" />
  <title>EatryHub - Mobile</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />

  <link rel="apple-touch-icon" href="/static/mobile/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="EatryHub">
  <meta name="theme-color" content="#ffffff">
  <link rel="apple-touch-icon" sizes="180x180" href="/static/mobile/apple-icon-180.png">
  <link rel="apple-touch-startup-image" href="/static/mobile/splash-1125x2436.png"
    media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3)">
  <link rel="apple-touch-startup-image" href="/static/mobile/splash-750x1334.png"
    media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)">
  <link rel="apple-touch-startup-image" href="/static/mobile/splash-1290x2796.png"
    media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3)">
  <link rel="manifest" href="/static/mobile/manifest.json" />
  <link rel="apple-touch-icon" sizes="180x180" href="/static/mobile/apple-icon-180.png">
  <link rel="shortcut icon" type="image/png" href="/static/favicon.ico" />
  <script type="module" src="https://cdn.jsdelivr.net/npm/@ionic/core@7.6.0/dist/ionic/ionic.esm.js"></script>
  <script nomodule src="https://cdn.jsdelivr.net/npm/@ionic/core@7.6.0/dist/ionic/ionic.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@ionic/core@7.6.0/css/ionic.bundle.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  <style>
    :root {
      /* These examples use the same color: sienna. */    
      /* These examples use the same color: lightsteelblue. */
      --ion-background-color: #e6e6e6;
      --ion-background-color-contrast: #fff;}
    
    ion-tab-bar {
      padding-bottom: env(safe-area-inset-bottom);
    }
    

    ion-content {
      padding-bottom: calc(65px + env(safe-area-inset-bottom));
    }
    .card-entry {
      margin: 10px;
      padding: 10px;
      border-radius: 10px;
      background: white;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
    }

    .warning { border: 2px solid orange; }
    .overdue { background-color: #ffdddd; }
    .plan-レモン { border-left: 8px solid #f0e68c; }
    .plan-単品 { border-left: 8px solid #696969; }
    .plan-スーパー { border-left: 8px solid #87cefa; }
    .plan-食べ飲み90m { border-left: 8px solid #90ee90; }
    .plan-食べ飲み120m { border-left: 8px solid #32cd32; }
    table {
      width: 100%;
      font-size: 0.9rem;
      border-collapse: collapse;
    }
    th, td {
      padding: 4px;
      border: 1px solid #ccc;
      text-align: center;
    }
    th {
      background: #eee;
      position: sticky;
      top: 0;
    }
    .alert-late {
      background-color: red !important;
      color: white !important;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    
    ion-tab-bar {
      padding-bottom: env(safe-area-inset-bottom);
    }
    
    ion-content {
      padding-bottom: calc(65px + env(safe-area-inset-bottom));
    }
    
    .table-container {
      padding-bottom: env(safe-area-inset-bottom);
    }

    /* 格子線 */
    ion-grid, ion-row, ion-col {
      --border-color: #ccc;
      --border-width: 0.5px;
    }
    ion-row {
      border-bottom: var(--border-width) solid var(--border-color);
    }
    ion-col {
      border-right: var(--border-width) solid var(--border-color);
      border-left: var(--border-width) solid var(--border-color);
      border-top: var(--border-width) solid var(--border-color);
      border-bottom: var(--border-width) solid var(--border-color);
      padding: 4px 2px;
      text-align: center;
      box-sizing: border-box;
    }
    /* 卓番・人数の幅を小さく */
    ion-row ion-col:nth-child(1),
    ion-row ion-col:nth-child(3) {
      max-width: 48px;
      min-width: 32px;
      width: 8vw;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    /* プラン名の列を広げる・改行防止・省略表示・フォントサイズ小さめ */
    ion-row ion-col:nth-child(2) {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 140px;
      min-width: 90px;
      width: 32vw;
      display: inline-block;
      vertical-align: middle;
      font-size: 0.85em;
    }
  </style>
</head>
<body>
  <ion-app>
    <ion-tabs>
      <ion-tab-bar slot="bottom">
        <ion-tab-button tab="home">
          <ion-icon name="home-outline"></ion-icon>
          <ion-label>ホーム</ion-label>
        </ion-tab-button>
        <ion-tab-button tab="cards">
          <ion-icon name="albums-outline"></ion-icon>
          <ion-label>カード</ion-label>
        </ion-tab-button>
        <ion-tab-button tab="table">
          <ion-icon name="grid-outline"></ion-icon>
          <ion-label>テーブル</ion-label>
        </ion-tab-button>
        <ion-tab-button tab="settings">
          <ion-icon name="settings-outline"></ion-icon>
          <ion-label>設定</ion-label>
        </ion-tab-button>
      </ion-tab-bar>

      <ion-tab tab="home">
        <ion-content>
          <ion-header translucent>
            <ion-toolbar>
              <ion-title>ホーム</ion-title>
            </ion-toolbar>
          </ion-header>
            <ion-card color="light">
              <ion-card-header>
                <ion-card-title>リリースノート</ion-card-title>
              </ion-card-header>
              <ion-card-content>
                ✔ モバイル版がリリースされました（2025/07/01）<br>
              </ion-card-content>
              </ion-card>

            <ion-card>
              <ion-card-header>
                <ion-card-title>モバイルアプリのインストール</ion-card-title>
              </ion-card-header>
              <ion-card-content>
                <ion-button id="install-button" expand="block" style="display:none;">ホーム画面に追加</ion-button>
              </ion-card-content>
          </ion-card>

            <ion-content class="ion-padding">
            <h4>本日の状況</h4>
            <ion-list id="seat-status-list"></ion-list>

          </ion-content>
        </ion-content>
      </ion-tab>

      <ion-tab tab="cards">
        <ion-content>
          <ion-header translucent>
            <ion-toolbar>
              <ion-title>カード表示</ion-title>
            </ion-toolbar>
          </ion-header>

          <ion-refresher id="card-refresher" slot="fixed">
            <ion-refresher-content
              pulling-icon="chevron-down-circle-outline"
              pulling-text="Pull to refresh"
              refreshing-spinner="circles"
              refreshing-text="更新中...">
            </ion-refresher-content>
          </ion-refresher>
      
          <div class="ion-padding">
            <input type="date" id="cardSelectedDate" class="form-control mb-2" />
          </div>
      
          <div id="card-container" class="ion-padding"></div>
        </ion-content>
      </ion-tab>

      <ion-tab tab="table">
        <ion-content>
          <ion-header translucent>
            <ion-toolbar>
              <ion-title>テーブル表示</ion-title>
            </ion-toolbar>
          </ion-header>
          
          <!-- リロード機能 -->
          <ion-refresher id="refresher" slot="fixed">
            <ion-refresher-content
              pulling-icon="chevron-down-circle-outline"
              pulling-text="Pull to refresh"
              refreshing-spinner="circles"
              refreshing-text="更新中...">
            </ion-refresher-content>
          </ion-refresher>

          <ion-content class="ion-padding">
            <input type="date" id="selectedDate" class="form-control" />
            <div class="table-container mb-5">
              <ion-grid>
                <ion-row>
                  <ion-col>卓番</ion-col>
                  <ion-col>プラン</ion-col>
                  <ion-col>人数</ion-col>
                  <ion-col>開始</ion-col>
                  <ion-col>ラスト</ion-col>
                  <ion-col>アウト</ion-col>
                </ion-row>
                <div id="table-body"></div>
              </ion-grid>
            </div>
          </ion-content>
        </ion-content>
      </ion-tab>
      <ion-tab tab="settings">
        <ion-content>
          <ion-header translucent>
            <ion-toolbar>
              <ion-title>設定</ion-title>
            </ion-toolbar>
          </ion-header>
          <ion-content class="ion-padding">
            <ion-item-group>
              <!-- 通知権限確認 -->
              <ion-item detail="true" button onclick="requestNotificationPermission()">
                <ion-icon name="notifications-outline" slot="start" size="small"></ion-icon>
                <ion-label>通知許可をリクエスト</ion-label>
              </ion-item>
              <ion-item detail="true" button onclick="logoutUser()">
              <ion-icon name="log-out-outline" slot="start"></ion-icon>
              <ion-label>ログアウト</ion-label>
            </ion-item>
            <ion-item detail="true" button onclick="clearLocalCache()">
              <ion-icon name="trash-outline" slot="start"></ion-icon>
              <ion-label>ローカルキャッシュ削除</ion-label>
            </ion-item>

            <ion-item detail="false">
              <ion-icon name="hardware-chip-outline" slot="start"></ion-icon>
              <ion-label>バージョン情報</ion-label>
              <ion-note slot="end">v1.0.0</ion-note>
            </ion-item>
            </ion-item-group>
          </ion-content>
        </ion-content>
      </ion-tab>
    </ion-tabs>
  </ion-app>

  <script>
    // サービスワーカ
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/static/mobile/service-worker.js')
        .then(() => console.log('✔ Service Worker registered'))
        .catch(err => console.error('✘ Service Worker failed', err));
    }
      // install-buttonイベント
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
    });

    // ページロード完了後にボタン表示＆イベント追加
    window.addEventListener('load', () => {
      const installBtn = document.getElementById('install-button');
      if (installBtn) {
        installBtn.style.display = 'block';
        installBtn.addEventListener('click', async () => {
          if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            console.log(`User response to install: ${outcome}`);
            deferredPrompt = null;
          }
        });
      }
    });
    function formatHHMM(value) {
      const raw = String(value || "").trim();
      if (/^\d{4}$/.test(raw)) {
        return `${raw.slice(0, 2)}:${raw.slice(2)}`;
      }
      if (/^\d{2}:\d{2}$/.test(raw)) {
        return raw;
      }
      return raw || "-";
    }

    function getTimeFromHHMM(str) {
      const raw = String(str || "").replace(/[^\d:]/g, "");
      const parts = raw.split(":");
      if (parts.length !== 2) return null;
      const d = new Date();
      d.setHours(parseInt(parts[0], 10), parseInt(parts[1], 10), 0, 0);
      return d;
    }

    function isPast(timeStr) {
      const t = getTimeFromHHMM(formatHHMM(timeStr));
      return t ? t < new Date() : false;
    }

    function logoutUser() {
      alert("ログアウト処理（未実装）");
      // 店舗切り替え機能実装予定
    }

    function requestNotificationPermission() {
      if (!('Notification' in window)) {
        alert('このブラウザは通知に対応していません');
        return;
      }
      Notification.requestPermission().then(permission => {
        alert(`通知の許可状態: ${permission}`);
        if (permission === 'granted') {
          // 許可されたらすぐにテスト通知
          new Notification('EatryHub', {
            body: '通知が有効になりました！',
          });
        }
      });
    }
    function clearLocalCache() {
      localStorage.clear();
      sessionStorage.clear();
      location.reload();
      alert("キャッシュを削除しました.")
    }
  async function calculateSeatStatus(records) {
    const now = new Date();
    const totalTables = new Set();
    const status = {
      total: 0,
      inUse: 0,
      vacant: 0,
      autoExtended: 0,
      invoiced: 0,
      overdue: 0
    };

    records.forEach(record => {
      const table = record.table_number || "";
      if (!table) return;

      totalTables.add(table);

      const start = record.start_time;
      const out = record.out_time;
      const hasStarted = start && String(start).trim() !== "";
      const hasPaid = record.checked?.paymentChecked;
      const hasInvoiced = record.checked?.invoiceChecked;

      if (hasStarted && !hasPaid) {
        status.inUse++;
      }

      if (!hasStarted) {
        status.vacant++;
      }

      if (record.extensions && record.extensions > 0 && record.plan_name === "レモン") {
        status.autoExtended++;
      }

      if (hasInvoiced && !hasPaid) {
        status.invoiced++;
      }

      try {
        const outDate = getTimeFromHHMM(out);
        if (outDate && outDate < now && !hasPaid) {
          status.overdue++;
        }
      } catch (e) {
        console.error(`Invalid out_time for record ${record.table_number}: ${out}`, e);
      }
    });

    status.total = totalTables.size;
    return status;
  }

    async function fetchData() {
      const date = document.getElementById("selectedDate").value || new Date().toISOString().slice(0, 10);
      const res = await fetch(`/TimeManagement/table-data-api/?selected_date=${date}`);
      const data = await res.json();
      const tbody = document.getElementById("table-body");
      tbody.innerHTML = "";

      // ソート: 白(未チェック)→ピンク(請求済み)→グレー(会計済み)
      function getColorOrder(record) {
        if (record.checked && record.checked.paymentChecked) return 2; // グレー
        if (record.checked && record.checked.invoiceChecked) return 1; // ピンク
        return 0; // 白
      }
      const sortedRecords = (data.records || []).slice().sort((a, b) => getColorOrder(a) - getColorOrder(b));

      sortedRecords.forEach(record => {
        if (!record.plan_name && !record.table_number && !record.people_count && !record.start_time) return;

        let last = "", leave = "";
        // 自動延長プランの場合
        if (record.has_auto_extend) {
          last = formatHHMM(record.end_time);
          leave = formatHHMM(record.out_time);
        } else if (record.has_lo && record.has_out) {
          // 時間制プランの場合
          last = formatHHMM(record.end_time);
          leave = formatHHMM(record.out_time);
        } else {
          // 単品等ノーマルプラン
          last = formatHHMM(record.end_time);
          leave = formatHHMM(record.out_time);
        }

        // ion-row生成
        const row = document.createElement("ion-row");

        // 背景色指定：会計済み → 灰色、請求済み → ピンク
        if (record.checked && record.checked.paymentChecked) {
          row.style.backgroundColor = "#a9a9a9";
          row.style.color = "black";
        } else if (record.checked && record.checked.invoiceChecked) {
          row.style.backgroundColor = "#ffc0cb";
          row.style.color = "black";
        }

        // 各セル
        const cols = [
          record.table_number || "",
          record.plan_name || "",
          record.people_count || "",
          formatHHMM(record.start_time),
          last,
          leave
        ];

        cols.forEach((val, idx) => {
          const col = document.createElement("ion-col");
          col.textContent = val;
          // ラスト・アウトの遅延アラート
          if (idx === 4 && isPast(last) && !(record.checked && record.checked.invoiceChecked)) {
            col.classList.add("alert-late");
          }
          if (idx === 5 && isPast(leave) && !(record.checked && record.checked.paymentChecked)) {
            col.classList.add("alert-late");
          }
          row.appendChild(col);
        });

        tbody.appendChild(row);
      });

      if (tbody.innerHTML.trim() === "") {
        const row = document.createElement("ion-row");
        const col = document.createElement("ion-col");
        col.setAttribute("size", "12");
        col.textContent = "データがありません";
        row.appendChild(col);
        tbody.appendChild(row);
      }
    }

    async function updateSeatStatus() {
      const res = await fetch(`/TimeManagement/table-data-api/`);
      const data = await res.json();
      const status = await calculateSeatStatus(data.records);

      const list = document.getElementById("seat-status-list");
      list.innerHTML = `
        <ion-item><ion-label>使用中</ion-label><ion-note slot="end">${status.inUse}</ion-note></ion-item>
        <ion-item><ion-label>請求済み未会計</ion-label><ion-note slot="end">${status.invoiced}</ion-note></ion-item>
        <ion-item><ion-label>アウト超過</ion-label><ion-note slot="end">${status.overdue}</ion-note></ion-item>
      `;
    }

    async function fetchCardData() {
      const date = document.getElementById("cardSelectedDate").value || new Date().toISOString().slice(0, 10);
      const res = await fetch(`/TimeManagement/table-data-api/?selected_date=${date}`);
      const data = await res.json();
      const container = document.getElementById("card-container");
      container.innerHTML = "";

      (data.records || []).forEach(record => {
        if (!record.plan_name && !record.table_number && !record.people_count && !record.start_time) return;

        let last = "", leave = "";
        // 自動延長プランの場合
        if (record.has_auto_extend) { 
          last = formatHHMM(record.end_time);
          leave = formatHHMM(record.out_time);
        } else if (record.has_lo && record.has_out) {
          // 時間制プランの場合 
          last = formatHHMM(record.end_time);
          leave = formatHHMM(record.out_time);
        } else {
          // 単品等ノーマルプラン
          last = formatHHMM(record.end_time);
          leave = formatHHMM(record.out_time);
        }

        const card = document.createElement("div");
        card.className = `card-entry plan-${record.plan_name || ""}`;

        // 背景色：会計済み → 灰色、請求済み → ピンク
        if (record.checked && record.checked.paymentChecked) {
          card.style.backgroundColor = "#a9a9a9";
          card.style.color = "black";
        } else if (record.checked && record.checked.invoiceChecked) {
          card.style.backgroundColor = "#ffc0cb";
          card.style.color = "black";
        }

        card.innerHTML = `
          <h5><b>${record.table_number || "-"}</b></h5>
          <p><b>${record.plan_name || "-"}</b></p>
          <p><strong>人数:</strong> ${record.people_count || "-"}</p>
          <p><strong>開始:</strong> ${formatHHMM(record.start_time)}</p>
          <p><strong>ラスト:</strong> ${last}</p>
          <p><strong>アウト:</strong> ${leave}</p>
        `;

        container.appendChild(card);
      });

      if (container.innerHTML.trim() === "") {
        container.innerHTML = `<p>データがありません</p>`;
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const cardDateInput = document.getElementById("cardSelectedDate");
      cardDateInput.value = new Date().toISOString().slice(0, 10);
      fetchCardData();
      cardDateInput.addEventListener("change", fetchCardData);
    });
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("selectedDate").value = new Date().toISOString().slice(0, 10);
      fetchData();
      setInterval(fetchData, 60000);
      document.getElementById("selectedDate").addEventListener("change", fetchData);
    });
    document.addEventListener("DOMContentLoaded", () => {
      updateSeatStatus();
      const dateInput = document.getElementById("selectedDate");
      const refresher = document.getElementById("refresher");

      dateInput.value = new Date().toISOString().slice(0, 10);
      fetchData();
      setInterval(fetchData, 60000);

      dateInput.addEventListener("change", fetchData);

      // Refresh
      refresher.addEventListener('ionRefresh', (event) => {
        fetchData().finally(() => {
          refresher.complete();
        });
      });
    });
    document.addEventListener("DOMContentLoaded", () => {
      const cardRefresher = document.getElementById("card-refresher");
      if (cardRefresher) {
        cardRefresher.addEventListener("ionRefresh", () => {
          fetchCardData().finally(() => {
            cardRefresher.complete();
          });
        });
      }
    });
  </script>
</body>
</html>